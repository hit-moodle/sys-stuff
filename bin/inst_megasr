#!/bin/sh

#############################
# 此脚本还未正式测试过！！！#
# 只测试过按流程手工操作    #
############################# 

# megasr是LSI闭源的LSI-8208ELP软raid驱动
# 本脚本为指定版本的内核安装该驱动
# 要求：
#   1. 当前加载的内核必须已经驱动过
#   2. 指定版本的内核已经安装

LIBMODULE="/lib/modules"
KOPATH="updates/megasr.ko"
INITRD="/boot/initrd-"
SOURCE_VER=`uname -r`

KOSRC="$LIBMODULE/$SOURCE_VER/$KOPATH"

if [ ! -r $KOSRC ]; then
    echo $KOSRC cannot be read or not exists.
    exit 1
fi

if [ "$1" == "" ]; then
    echo Target kernel version must be specified. Available version:
    ls -1 $LIBMODULE | grep -v $SOURCE_VER
    exit 2
fi

TARGET_VER=$1
KODST="$LIBMODULE/$TARGET_VER/$KOPATH"

cp -pi "$KOSRC" "$KODST"
/sbin/depmod $TARGET_VER
mv -i $INITRD$TARGET_VER.img $INITRD$TARGET_VER.img.old
/sbin/mkinitrd $INITRD$TARGET_VER.img $TARGET_VER
